#!/bin/sh

MOD_PATH="/lib/modules/$(uname -r)/extra/"

case "$1" in
  start)
    echo "Loading kernel modules..."

    # Load scull module
    if insmod "$MOD_PATH"scull.ko; then
        echo "scull module loaded successfully"
    else
        echo "Failed to load scull module"
        exit 1
    fi


    # Load faulty module
    if insmod "$MOD_PATH"faulty.ko; then
        echo "faulty module loaded successfully"
    else
        echo "Failed to load faulty module"
        rmmod scull
        exit 1
    fi

    # Load hello module
    if modprobe hello; then
        echo "hello module loaded successfully"
    else
        echo "Failed to load hello module"
        rmmod faulty
        rmmod scull
        exit 1
    fi

    echo "All modules loaded successfully"
    ;;

  stop)
    echo "Unloading kernel modules..."

    # Unload in reverse order
    modprobe -r hello || echo "Failed to unload hello module"
    rmmod faulty || echo "Failed to unload faulty module"
    rmmod scull || echo "Failed to unload scull module"

    # Remove device nodes

    echo "Modules unloaded and device nodes removed"
    ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;
esac

exit 0